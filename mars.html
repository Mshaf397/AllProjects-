<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mars Clock — Calendar with Leap Months</title>
  <style>
    body { background:#040618; color:#ffd7b5; font-family: "Courier New", monospace; display:flex; align-items:center; justify-content:center; height:100vh; margin:0 }
    .card { text-align:center }
    .label { font-size:1.0rem; opacity:0.9; margin-bottom:0.25rem }
    .date { font-size:1.2rem; margin-bottom:0.5rem }
    .time { font-size:2rem }
    .muted { opacity:0.8; font-size:0.9rem }
  </style>
</head>
<body>
  <div class="card">
    <div class="label">Mars Clock</div>
    <div id="mars-date" class="date">---- - -- - --</div>
    <div id="mars-time" class="time">--:--:--</div>
    <div class="muted">Epoch: 2000-01-01 12:00:00 UTC — Mars year numbering starts at 0001 at the epoch.</div>
  </div>

<script>
// === Constants (Earth seconds) ===
const SEC_PER_EARTH_DAY = 86400;
const MARS_SOL_EARTH_DAYS = 1.02749;                    // 1 Mars day = 1.02749 Earth days
const MARS_SOL_SECONDS = MARS_SOL_EARTH_DAYS * SEC_PER_EARTH_DAY; // ~88775.136 s

const MARS_MONTH_EARTH_DAYS = 33.90717; // given (33.90717 Earth days) -> exactly 33 sols
const MARS_MONTH_SOLS = Math.round(MARS_MONTH_EARTH_DAYS / MARS_SOL_EARTH_DAYS); // 33 sols
const MARS_MONTH_SECONDS = MARS_MONTH_EARTH_DAYS * SEC_PER_EARTH_DAY;

const MARS_HOUR_SECONDS = 39.9888 * 60; // 39.9888 minutes -> 2399.328 s
const MARS_MINUTE_SECONDS = 50;         // 50 Earth seconds per Mars minute
const MARS_SECOND_SECONDS = 1;          // same as Earth second

// Calendar rules
const BASE_DAYS_PER_YEAR = 660;         // base sols per year
const MONTHS_PER_BASE_YEAR = BASE_DAYS_PER_YEAR / MARS_MONTH_SOLS; // 660/33 = 20 months
const LEAP_MONTH_DAYS = MARS_MONTH_SOLS; // 33 sols added for leap month

// Leap month rule: every 4 years add a leap month, except every 16th year (i.e., skip if divisible by 16)
// This is applied to years numbered starting at 1. So year Y is leap if (Y % 4 == 0) && (Y % 16 != 0).
function isLeapYear(year) {
  // year is 1-based
  if (year % 4 !== 0) return false;
  if (year % 16 === 0) return false;
  return true;
}

// To handle long spans efficiently we use 16-year cycles (pattern repeats every 16 years)
const CYCLE_YEARS = 16;
// Count leaps in a 16-year cycle: years divisible by 4 but not by 16 => {4,8,12} => 3 leaps
const LEAPS_PER_CYCLE = 3;
const DAYS_PER_CYCLE = BASE_DAYS_PER_YEAR * CYCLE_YEARS + LEAP_MONTH_DAYS * LEAPS_PER_CYCLE; // 660*16 + 33*3

// Precompute cumulative days at year boundaries within a cycle for quick lookup
const cumulativeDaysInCycle = (function() {
  const arr = [0]; // cumulative days before year 1
  let acc = 0;
  for (let y = 1; y <= CYCLE_YEARS; y++) {
    let daysThisYear = BASE_DAYS_PER_YEAR + (isLeapYear(y) ? LEAP_MONTH_DAYS : 0);
    acc += daysThisYear;
    arr.push(acc);
  }
  return arr; // length 17, arr[i] = total days in first i years of cycle
})();

// Epoch
const EPOCH_MS = Date.UTC(2000, 0, 1, 12, 0, 0);

function findYearAndDay(totalSols) {
  // totalSols: integer sols since epoch (0-based)
  // fast-forward by whole cycles
  const cycles = Math.floor(totalSols / DAYS_PER_CYCLE);
  let dayInCycle = totalSols - cycles * DAYS_PER_CYCLE; // 0-based day index within cycle

  // binary search in cumulativeDaysInCycle (small array)
  let lo = 0, hi = CYCLE_YEARS; // hi inclusive index of years
  while (lo < hi) {
    const mid = Math.floor((lo + hi + 1) / 2);
    if (cumulativeDaysInCycle[mid] <= dayInCycle) lo = mid;
    else hi = mid - 1;
  }
  const yearIndexInCycle = lo; // number of complete years before current year (0..15)
  const dayOfYear0 = dayInCycle - cumulativeDaysInCycle[yearIndexInCycle]; // 0-based within current year

  const yearWithinCycle = yearIndexInCycle + 1; // 1-based within cycle
  const absoluteYear = cycles * CYCLE_YEARS + yearWithinCycle; // 1-based year number

  // compute days in this year
  const daysThisYear = BASE_DAYS_PER_YEAR + (isLeapYear(absoluteYear) ? LEAP_MONTH_DAYS : 0);

  return { year: absoluteYear, dayOfYear0: dayOfYear0, daysThisYear: daysThisYear };
}

function updateClock() {
  const nowMs = Date.now();
  const elapsedSec = (nowMs - EPOCH_MS) / 1000; // fractional seconds

  // total whole sols since epoch
  const totalSols = Math.floor(elapsedSec / MARS_SOL_SECONDS);

  // find year and day-of-year
  const { year, dayOfYear0, daysThisYear } = findYearAndDay(totalSols);

  // month and day within month
  const monthIndex = Math.floor(dayOfYear0 / MARS_MONTH_SOLS); // 0-based
  const dayOfMonth = (dayOfYear0 % MARS_MONTH_SOLS) + 1; // 1-based

  // seconds into current sol
  const secondsIntoSol = elapsedSec - totalSols * MARS_SOL_SECONDS;
  let r = secondsIntoSol;

  const hours = Math.floor(r / MARS_HOUR_SECONDS); r -= hours * MARS_HOUR_SECONDS;
  const minutes = Math.floor(r / MARS_MINUTE_SECONDS); r -= minutes * MARS_MINUTE_SECONDS;
  const seconds = Math.floor(r / MARS_SECOND_SECONDS); r -= seconds * MARS_SECOND_SECONDS;

  // Format
  const YYYY = year.toString().padStart(4, '0');
  const MM = (monthIndex + 1).toString().padStart(2, '0');
  const DD = dayOfMonth.toString().padStart(2, '0');

  const HH = hours.toString().padStart(2, '0');
  const MIN = minutes.toString().padStart(2, '0');
  const SS = seconds.toString().padStart(2, '0');

  document.getElementById('mars-date').textContent = `Y${YYYY} M${MM} D${DD}`;
  document.getElementById('mars-time').textContent = `${HH}:${MIN}:${SS}.${SUB}`;
}

// initial + interval
updateClock();
setInterval(updateClock, 200);
</script>
</body>
</html>
