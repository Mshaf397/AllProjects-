<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather App with Map Picker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
.tabs { display: flex; background: #333; }
.tab-button { flex: 1; padding: 10px; background: #444; color: #fff; cursor: pointer; text-align: center; }
.tab-button.active { background: #666; }
.tab-content { display: none; padding: 10px; }
.tab-content.active { display: block; }
#map { height: 300px; margin-bottom: 10px; }
.weather-item { padding: 4px 0; border-bottom: 1px solid #ddd; }
</style>
</head>
<body>

<div class="tabs">
    <div class="tab-button active" data-tab="current">Current Weather</div>
    <div class="tab-button" data-tab="hourly">Hourly Forecast</div>
    <div class="tab-button" data-tab="daily">Daily Forecast</div>
</div>

<div id="current" class="tab-content active">
    <h2 id="locationName">Loading...</h2>
    <div id="map"></div>
    <div id="currentWeather"></div>
</div>

<div id="hourly" class="tab-content">
    <h2>Hourly Forecast</h2>
    <div id="hourlyWeather"></div>
</div>

<div id="daily" class="tab-content">
    <h2>Daily Forecast</h2>
    <div id="dailyWeather"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Tab switching
document.querySelectorAll(".tab-button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});

let map, marker;
document.addEventListener("DOMContentLoaded", () => {
    initMap();
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            map.setView([lat, lon], 8);
            marker.setLatLng([lat, lon]);
            updateWeatherFromMap(lat, lon);
        }, () => {
            updateWeatherFromMap(40.7128, -74.0060); // NYC fallback
        });
    } else {
        updateWeatherFromMap(40.7128, -74.0060);
    }
});

function initMap() {
    map = L.map('map').setView([40.7128, -74.0060], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    marker = L.marker([40.7128, -74.0060], { draggable: true }).addTo(map);
    map.on('click', e => {
        marker.setLatLng(e.latlng);
        updateWeatherFromMap(e.latlng.lat, e.latlng.lng);
    });
    marker.on('dragend', e => {
        const pos = marker.getLatLng();
        updateWeatherFromMap(pos.lat, pos.lng);
    });
}

async function updateWeatherFromMap(lat, lon) {
    // Reverse geocode
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await res.json();
    document.getElementById("locationName").textContent = data.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    fetchWeather(lat, lon);
}

async function fetchWeather(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,rain,showers,snowfall,cloud_cover,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,wind_speed_10m,wind_direction_10m,pressure_msl,dew_point_2m,visibility&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,rain_sum,snowfall_sum,precipitation_hours,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant,sunrise,sunset,uv_index_max,uv_index_clear_sky_max&forecast_days=16&timezone=auto`;
    const res = await fetch(url);
    const weather = await res.json();
    renderCurrent(weather);
    renderHourly(weather);
    renderDaily(weather);
}

function renderCurrent(w) {
    const c = w.current;
    document.getElementById("currentWeather").innerHTML = `
        <div class="weather-item">Temp: ${c.temperature_2m}°C</div>
        <div class="weather-item">Feels Like: ${c.apparent_temperature}°C</div>
        <div class="weather-item">Humidity: ${c.relative_humidity_2m}%</div>
        <div class="weather-item">Precipitation: ${c.precipitation} mm</div>
        <div class="weather-item">Cloud Cover: ${c.cloud_cover}%</div>
        <div class="weather-item">Wind: ${c.wind_speed_10m} km/h @ ${c.wind_direction_10m}°</div>
    `;
}

function renderHourly(w) {
    const times = w.hourly.time;
    const temp = w.hourly.temperature_2m;
    const feels = w.hourly.apparent_temperature;
    const precip = w.hourly.precipitation;
    let html = "";
    for (let i = 0; i < times.length; i++) {
        html += `<div class="weather-item">
            ${times[i]}: ${temp[i]}°C (Feels: ${feels[i]}°C) — Precip: ${precip[i]} mm
        </div>`;
    }
    document.getElementById("hourlyWeather").innerHTML = html;
}

function renderDaily(w) {
    const times = w.daily.time;
    const tmax = w.daily.temperature_2m_max;
    const tmin = w.daily.temperature_2m_min;
    const precip = w.daily.precipitation_sum;
    const sunrise = w.daily.sunrise;
    const sunset = w.daily.sunset;
    let html = "";
    for (let i = 0; i < times.length; i++) {
        html += `<div class="weather-item">
            ${times[i]} — Max: ${tmax[i]}°C, Min: ${tmin[i]}°C, Precip: ${precip[i]} mm, 
            Sunrise: ${sunrise[i]}, Sunset: ${sunset[i]}
        </div>`;
    }
    document.getElementById("dailyWeather").innerHTML = html;
}
</script>
</body>
</html>