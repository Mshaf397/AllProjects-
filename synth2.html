<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Microtonal Ups/Downs Synth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #020617;
            --card-bg: #1e293b;
            --accent: #3b82f6;
        }
        body {
            background-color: var(--bg-color);
            color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            touch-action: none;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        .grid-container {
            flex-grow: 1;
            overflow: auto;
            position: relative;
            background: #000;
            cursor: grab;
            -ms-overflow-style: none;
            scrollbar-width: thin;
        }
        .grid-container:active {
            cursor: grabbing;
        }
        .synth-grid {
            display: grid;
            position: relative;
            min-width: min-content;
            min-height: min-content;
        }
        .key {
            border: 1px solid #11457b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            user-select: none;
            background: #0f1ffa;
            transition: background 0.05s;
            pointer-events: auto;
            touch-action: none; /* Critical for preventing browser scroll/zoom interference */
        }
        .key.active {
            background-color: var(--accent) !important;
            color: white;
        }
        .controls-panel {
            background: #def827;
            border-top: 1px solid #3dfd51;
            padding: 1rem;
            max-height: 45vh;
            overflow-y: auto;
            z-index: 50;
        }
        input[type="number"], input[type="text"] {
            background: #1f5937;
            border: 1px solid #4b6f63;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            width: 100%;
        }
        .custom-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #004151;
            border-radius: 5px;
            outline: none;
        }
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <div id="grid-viewport" class="grid-container">
        <div id="synth-grid" class="synth-grid"></div>
    </div>

    <div class="controls-panel">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-3">
                <h3 class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">Oscillator & Volume</h3>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">EDO</label>
                    <input type="number" id="edo-input" value="12" min="1" class="w-24">
                </div>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">Volume</label>
                    <input type="range" id="volume-slider" class="custom-slider w-24" min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="sustain-toggle">
                    <label for="sustain-toggle" class="text-xs">Sustain (Sticky Keys)</label>
                </div>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">Key Size (px)</label>
                    <input type="number" id="key-size-input" value="70" min="20" class="w-24">
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">Grid Layout</h3>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">Columns</label>
                    <input type="number" id="cols-input" value="24" min="1" class="w-24">
                </div>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">Rows</label>
                    <input type="number" id="rows-input" value="10" min="1" class="w-24">
                </div>
                <div class="flex items-center justify-between gap-4">
                    <label class="text-xs">Row Step Offset</label>
                    <input type="number" id="row-offset-input" value="7" class="w-24">
                </div>
                <button id="refresh-grid" class="w-full bg-blue-600 hover:bg-blue-700 py-1.5 rounded text-xs font-bold transition">Update Grid</button>
            </div>

            <div class="space-y-3">
                <h3 class="text-blue-400 font-bold uppercase text-[10px] tracking-widest">Note Logic</h3>
                <p class="text-[9px] text-slate-400">C4 = 261.6256 Hz</p>
                <div id="status-info" class="text-[9px] text-slate-300 bg-black/40 p-2 rounded leading-tight border border-slate-700">
                    Initializing...
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px]">Find Note (Cents / Ratio / Step)</label>
                    <div class="flex gap-1">
                        <input type="text" id="calc-input" placeholder="3/2 or 702c" class="text-xs">
                        <button id="calc-btn" class="bg-slate-700 hover:bg-slate-600 px-3 rounded text-xs">Find</button>
                    </div>
                    <div id="calc-result" class="text-[10px] text-blue-300 italic"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        masterGain.gain.value = 0.5;

        const activeOscs = new Map();
        const C4_FREQ = 261.6256;

        const CHAIN_OF_FIFTHS = [
            "Fbb", "Cbb", "Gbb", "Dbb", "Abb", "Ebb", "Bbb", 
            "Fb", "Cb", "Gb", "Db", "Ab", "Eb", "Bb", 
            "F", "C", "G", "D", "A", "E", "B", 
            "F#", "C#", "G#", "D#", "A#", "E#", "B#", 
            "Fx", "Cx", "Gx"
        ];
        const C_INDEX = 15;

        const state = {
            edo: 12,
            cols: 24,
            rows: 10,
            rowOffset: 7,
            keySize: 70,
            sustain: false
        };

        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        function setupPanning() {
            const slider = document.getElementById('grid-viewport');

            // Mouse Events
            slider.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('key')) return;
                isDragging = true;
                startX = e.pageX - slider.offsetLeft;
                startY = e.pageY - slider.offsetTop;
                scrollLeft = slider.scrollLeft;
                scrollTop = slider.scrollTop;
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
            });

            slider.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const y = e.pageY - slider.offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                slider.scrollLeft = scrollLeft - walkX;
                slider.scrollTop = scrollTop - walkY;
            });

            // Touch Events (for areas NOT on keys)
            slider.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('key')) return;
                isDragging = true;
                startX = e.touches[0].pageX - slider.offsetLeft;
                startY = e.touches[0].pageY - slider.offsetTop;
                scrollLeft = slider.scrollLeft;
                scrollTop = slider.scrollTop;
            }, {passive: true});

            slider.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX - slider.offsetLeft;
                const y = e.touches[0].pageY - slider.offsetTop;
                const walkX = (x - startX);
                const walkY = (y - startY);
                slider.scrollLeft = scrollLeft - walkX;
                slider.scrollTop = scrollTop - walkY;
            }, {passive: true});
        }

        function getBestFifth(edo) {
            return Math.round((701.9550009 / 1200) * edo);
        }

        function getNoteName(step, edo) {
            const best5th = getBestFifth(edo);
            let candidates = [];
            for (let i = 0; i < CHAIN_OF_FIFTHS.length; i++) {
                const fifthSpan = i - C_INDEX;
                const baseStep = ((fifthSpan * best5th) % edo + edo) % edo;
                let diff = step - baseStep;
                if (diff > edo / 2) diff -= edo;
                if (diff < -edo / 2) diff += edo;
                candidates.push({
                    name: CHAIN_OF_FIFTHS[i],
                    arrows: diff,
                    absArrows: Math.abs(diff),
                    absFifthSpan: Math.abs(fifthSpan)
                });
            }
            candidates.sort((a, b) => {
                if (a.absArrows !== b.absArrows) return a.absArrows - b.absArrows;
                return a.absFifthSpan - b.absFifthSpan;
            });
            const best = candidates[0];
            let finalName = best.name;
            if (best.arrows > 0) finalName = "^".repeat(best.arrows) + finalName;
            if (best.arrows < 0) finalName = "v".repeat(Math.abs(best.arrows)) + finalName;
            return finalName;
        }

        function getFrequency(totalStep, edo) {
            return C4_FREQ * Math.pow(2, totalStep / edo);
        }

        function playNote(totalStep) {
            if (activeOscs.has(totalStep)) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(getFrequency(totalStep, state.edo), audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.02);
            
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            
            activeOscs.set(totalStep, { osc, gain });
            const el = document.querySelector(`[data-step="${totalStep}"]`);
            if (el) el.classList.add('active');
        }

        function stopNote(totalStep) {
            const entry = activeOscs.get(totalStep);
            if (entry) {
                entry.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03);
                setTimeout(() => {
                    try {
                        entry.osc.stop();
                        entry.osc.disconnect();
                    } catch(e) {}
                }, 150);
                activeOscs.delete(totalStep);
                const el = document.querySelector(`[data-step="${totalStep}"]`);
                if (el) el.classList.remove('active');
            }
        }

        function render() {
            const grid = document.getElementById('synth-grid');
            grid.innerHTML = '';
            
            const { edo, rows, cols, rowOffset, keySize } = state;
            grid.style.gridTemplateColumns = `repeat(${cols}, ${keySize}px)`;
            grid.style.width = `${cols * keySize}px`;

            for (let r = rows - 1; r >= 0; r--) {
                for (let c = 0; c < cols; c++) {
                    const totalStep = (r * rowOffset) + c;
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.style.width = `${keySize}px`;
                    key.style.height = `${keySize}px`;
                    key.dataset.step = totalStep;

                    const octave = Math.floor(totalStep / edo) + 4;
                    const stepInOctave = ((totalStep % edo) + edo) % edo;
                    const name = getNoteName(stepInOctave, edo);

                    key.innerHTML = `
                        <span class="font-bold text-blue-100">${name}${octave}</span>
                        <span class="text-[8px] opacity-40 mt-1">${getFrequency(totalStep, edo).toFixed(2)}</span>
                    `;

                    // Consolidated Event Handler to prevent double triggers
                    const onActionDown = (e) => {
                        // Prevent the browser from firing secondary events (like mousedown after touchstart)
                        if (e.cancelable) e.preventDefault();
                        
                        if (state.sustain) {
                            if (activeOscs.has(totalStep)) stopNote(totalStep);
                            else playNote(totalStep);
                        } else {
                            playNote(totalStep);
                        }
                    };

                    const onActionUp = (e) => {
                        if (!state.sustain) stopNote(totalStep);
                    };

                    // Use touchstart and mousedown but prevent mousedown if touch happened
                    key.addEventListener('touchstart', onActionDown, { passive: false });
                    key.addEventListener('mousedown', (e) => {
                        // On desktop, touch events won't fire, so this proceeds.
                        // On mobile, touchstart's preventDefault() stops this from firing.
                        onActionDown(e);
                    });

                    key.addEventListener('touchend', onActionUp);
                    key.addEventListener('mouseup', onActionUp);
                    key.addEventListener('mouseleave', onActionUp);

                    grid.appendChild(key);
                }
            }

            const fifth = getBestFifth(edo);
            const cents = (fifth * 1200 / edo).toFixed(4);
            document.getElementById('status-info').innerHTML = 
                `EDO: ${edo}<br>Best 5th: Step ${fifth} (${cents}c)`;
        }

        function parseScaleInput(val, edo) {
            if (val.includes('/')) {
                const [n, d] = val.split('/').map(Number);
                const cents = 1200 * Math.log2(n / d);
                const step = Math.round((cents / 1200) * edo);
                return { step, cents };
            }
            if (val.toLowerCase().endsWith('c')) {
                const cents = parseFloat(val);
                const step = Math.round((cents / 1200) * edo);
                return { step, cents };
            }
            const step = parseInt(val);
            return { step, cents: step * (1200 / edo) };
        }

        window.onload = () => {
            render();
            setupPanning();

            document.getElementById('refresh-grid').onclick = () => {
                state.edo = parseInt(document.getElementById('edo-input').value) || 12;
                state.cols = parseInt(document.getElementById('cols-input').value) || 12;
                state.rows = parseInt(document.getElementById('rows-input').value) || 5;
                state.rowOffset = parseInt(document.getElementById('row-offset-input').value) || 0;
                state.keySize = parseInt(document.getElementById('key-size-input').value) || 70;
                
                // Clear existing notes
                const keysToStop = Array.from(activeOscs.keys());
                keysToStop.forEach(s => stopNote(s));
                render();
            };

            document.getElementById('volume-slider').oninput = (e) => {
                masterGain.gain.value = parseFloat(e.target.value);
            };

            document.getElementById('sustain-toggle').onchange = (e) => {
                state.sustain = e.target.checked;
                if (!state.sustain) {
                    const keysToStop = Array.from(activeOscs.keys());
                    keysToStop.forEach(s => stopNote(s));
                }
            };

            document.getElementById('calc-btn').onclick = () => {
                const val = document.getElementById('calc-input').value;
                if (!val) return;
                const { step, cents } = parseScaleInput(val, state.edo);
                const stepInOct = ((step % state.edo) + state.edo) % state.edo;
                const name = getNoteName(stepInOct, state.edo);
                const currentCents = (step * 1200 / state.edo).toFixed(2);
                document.getElementById('calc-result').innerText = 
                    `Step ${step} (${name}) â‰ˆ ${currentCents}c (Err: ${(cents - currentCents).toFixed(2)}c)`;
            };
        };
    </script>
</body>
</html>