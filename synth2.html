<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microtonal EDO Synthesizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for Web Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom scrollbar for scale definition output */
        .scale-output-box::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scale-output-box::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        .scale-output-box::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
        /* Style for the keyboard keys */
        .synth-key {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            background-color: #374151; /* Gray-700 */
            border: 1px solid #1f2937; /* Gray-800 */
            transition: transform 0.05s, background-color 0.1s;
            cursor: pointer;
            user-select: none;
            overflow: hidden; /* Hide overflow arrow text */
            position: relative;
        }
        .synth-key:hover {
            background-color: #4b5563; /* Gray-600 */
        }
        .synth-key.active {
            background-color: #10b981; /* Emerald-500 */
            transform: scale(0.98);
            box-shadow: 0 0 10px #10b981;
        }
        .key-name {
            font-size: 0.75rem; /* text-xs */
            color: #d1d5db; /* Gray-300 */
            padding-bottom: 0.25rem;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 font-sans antialiased">

    <!-- Main Container -->
    <div id="app" class="max-w-7xl mx-auto space-y-6">

        <!-- Header and Global Controls -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-emerald-400 mb-2">Microtonal EDO Synth</h1>
            <p class="text-sm text-gray-400">
                Tuning: <span id="current-edo">12</span>-EDO | C4 Freq: <span id="base-freq-display">261.6256</span> Hz (Fixed)
            </p>
        </header>

        <!-- Controls Section -->
        <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- EDO and Scale Definition -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold border-b border-gray-700 pb-2 text-emerald-300">Tuning & Scale</h2>
                <div>
                    <label for="edo-input" class="block text-sm font-medium text-gray-300">EDO (Equal Division of the Octave):</label>
                    <input type="number" id="edo-input" value="12" min="1" max="2147483647" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" onchange="initializeSynth()">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Base Frequency Input: Now Read-only and enforces C4_FREQ_REF -->
                    <div>
                        <label for="base-freq-input" class="block text-sm font-medium text-gray-300">Fixed C4 Frequency (Hz):</label>
                        <input type="number" id="base-freq-input" value="261.6256" step="0.0001" min="10" max="20000" 
                               class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 cursor-not-allowed" 
                               readonly>
                        <p class="text-xs text-gray-500 mt-1">C4 is fixed to 261.6256 Hz.</p>
                    </div>
                    <div>
                        <label for="root-key-input" class="block text-sm font-medium text-gray-300">C-Note Grid Index (0 to Keys-1):</label>
                        <input type="number" id="root-key-input" value="0" min="0" max="31" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" onchange="updateTuningParameters()">
                    </div>
                </div>

                <!-- Scale Output -->
                <div class="space-y-2">
                    <h3 class="text-md font-medium text-gray-300">EDO Scale (Steps 0 to EDO-1):</h3>
                    <div id="scale-output" class="scale-output-box h-40 overflow-y-auto bg-gray-900 p-3 rounded-lg text-xs font-mono border border-gray-700">
                        Loading scale...
                    </div>
                </div>
            </div>

            <!-- Keyboard Layout -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold border-b border-gray-700 pb-2 text-emerald-300">Keyboard Layout</h2>
                <div>
                    <label for="key-size" class="block text-sm font-medium text-gray-300">Key Size (px): <span id="key-size-value">50</span>px</label>
                    <input type="range" id="key-size" min="30" max="100" value="50" class="w-full mt-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="updateKeyLayout()">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="rows-input" class="block text-sm font-medium text-gray-300">Rows:</label>
                        <input type="number" id="rows-input" value="4" min="1" max="2147483647" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" onchange="updateKeyLayout()">
                    </div>
                    <div>
                        <label for="cols-input" class="block text-sm font-medium text-gray-300">Columns:</label>
                        <input type="number" id="cols-input" value="8" min="1" max="2147483647" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" onchange="updateKeyLayout()">
                    </div>
                </div>
                <p class="text-xs text-gray-500 pt-2">Total Keys: <span id="total-keys">32</span></p>
            </div>

            <!-- Audio Controls -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold border-b border-gray-700 pb-2 text-emerald-300">Audio Controls</h2>
                <div>
                    <label for="volume-slider" class="block text-sm font-medium text-gray-300">Volume (dB): <span id="volume-value">-10</span></label>
                    <input type="range" id="volume-slider" min="-60" max="0" value="-10" class="w-full mt-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="updateVolume()">
                </div>
                <div class="flex items-center justify-between">
                    <label for="sustain-toggle" class="text-sm font-medium text-gray-300">Sustain On/Off (Tap to Release)</label>
                    <input type="checkbox" id="sustain-toggle" class="h-6 w-10 rounded-full appearance-none bg-gray-700 checked:bg-emerald-500 transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-emerald-500" onclick="updateSustain()">
                </div>
                <div class="mt-4 p-3 bg-gray-900 rounded-lg text-sm text-center">
                    <p class="text-gray-400">Touch/Click a playing key to release it when Sustain is ON.</p>
                </div>
                <!-- Play button for initial Tone.js start -->
                <button id="start-audio" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.35 1.576-.877l8.835 6.007a1.125 1.125 0 0 1 0 1.754l-8.835 6.007a1.125 1.125 0 0 1-1.576-.877V5.653Z" />
                    </svg>
                    Start Audio (Required)
                </button>
            </div>
        </div>

        <!-- Keyboard Display Area -->
        <div id="keyboard-container" class="p-4 bg-gray-800 rounded-xl shadow-2xl flex justify-center items-center overflow-x-auto overflow-y-hidden">
            <div id="keyboard-grid" class="flex flex-wrap border-2 border-gray-700 rounded-lg">
                <!-- Keys will be dynamically injected here -->
                <p class="text-gray-500 p-10">Press 'Start Audio' and set EDO/Layout to generate the keyboard.</p>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE & CONSTANTS ---
        // The C4 reference frequency is now the fixed, enforced frequency for the key named 'C4'.
        const C4_FREQ_REF = 261.6256; 
        const P5_CENTS = 701.9550009; // Target perfect fifth in cents
        const CENTS_PER_OCTAVE = 1200;

        // The 31-limit chain of fifths, centered at C (index 15)
        const FIFTH_CHAIN = [
            'Fbb', 'Cbb', 'Gbb', 'Dbb', 'Abb', 'Ebb', 'Bbb', 'Fb', 'Cb', 'Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F',
            'C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'G#', 'D#', 'A#', 'E#', 'B#', 'Fx', 'Cx', 'Gx'
        ];

        let EDO = 12;
        // baseFreq is the calculated frequency of the first key (grid index 0) required to enforce C4_FREQ_REF.
        let baseFreq = C4_FREQ_REF; 
        // This stores the index of the grid key (0 to totalKeys-1) that maps to EDO step 0 ('C').
        let cNoteGridIndex = 0; 
        let scaleData = []; // Array of {step, name} for EDO steps 0 to EDO-1
        let synth = null;
        let gainNode = null;
        let sustainActive = false;
        let currentNotes = new Map(); // Tracks currently playing notes: Map<keyIndex, boolean>

        // --- SYNTH AUDIO SETUP (Tone.js) ---

        /** Initializes the Tone.js context, gain, and basic synth. */
        function setupAudio() {
            if (synth) return;

            gainNode = new Tone.Gain(Tone.dbToGain(-10)).toDestination();

            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.5,
                    release: 1.0
                }
            }).connect(gainNode);

            updateVolume();
            console.log("Audio setup complete.");
        }

        /** Starts the Tone.js audio context on user interaction. */
        document.getElementById('start-audio').addEventListener('click', async () => {
            await Tone.start();
            setupAudio();
            document.getElementById('start-audio').style.display = 'none';
            console.log("Audio Context Started.");
            initializeSynth();
        });

        /** Updates the global volume (in dB). */
        function updateVolume() {
            const slider = document.getElementById('volume-slider');
            const valueDisplay = document.getElementById('volume-value');
            const volumeDb = parseFloat(slider.value);
            valueDisplay.textContent = volumeDb;
            if (gainNode) {
                gainNode.gain.rampTo(Tone.dbToGain(volumeDb), 0.05);
            }
        }

        /** Toggles the sustain mode. */
        function updateSustain() {
            sustainActive = document.getElementById('sustain-toggle').checked;
            console.log('Sustain:', sustainActive);
        }

        /** Plays a note. */
        function playNote(keyIndex, freq) {
            if (!synth) return;
            
            // Check for "Tap to Release" functionality
            if (currentNotes.has(keyIndex)) {
                if (sustainActive) {
                    // Note is playing and sustain is ON: Release it.
                    releaseNote(keyIndex, freq);
                }
                // If sustain is OFF, we ignore subsequent play events until keyup/touchend
                return;
            }

            // Start the note
            synth.triggerAttack(freq, Tone.now(), 1); 
            currentNotes.set(keyIndex, true); 
            const keyElement = document.getElementById(`key-${keyIndex}`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
        }

        /** Stops a note. */
        function stopNote(keyIndex, freq) {
            if (!synth || !currentNotes.has(keyIndex)) return;

            // In non-sustain mode, we release on keyup/touchend/mouseleave
            if (!sustainActive) {
                releaseNote(keyIndex, freq);
            }
            // If sustain is ON, only the tap-to-release logic inside playNote can stop it.
        }

        /** Performs the actual Tone.js release and UI update. */
        function releaseNote(keyIndex, freq) {
            if (!currentNotes.has(keyIndex)) return;
            synth.triggerRelease(freq);
            currentNotes.delete(keyIndex);
            
            const keyElement = document.getElementById(`key-${keyIndex}`);
            if (keyElement) {
                keyElement.classList.remove('active');
            }
        }

        // --- CORE LOGIC: TUNING AND NAMING ---

        /**
         * Calculates the EDO scale naming scheme.
         * @param {number} EDO - The equal division of the octave.
         * @returns {Array<object>} - Scale data with {step, name}.
         */
        function calculateScaleNames(EDO) {
            if (EDO < 1) return [];

            const stepSizeCents = CENTS_PER_OCTAVE / EDO;
            const P5Steps = Math.round(P5_CENTS / stepSizeCents);
            const scale = [];
            const namedSteps = new Map(); // Map<step, {name, fifthSpan}>

            // Initialize scale array (only name required here)
            for (let k = 0; k < EDO; k++) {
                scale.push({ step: k, name: '' });
            }

            // 1. Apply Chain of Fifths Naming (Fbb to Gx)
            for (let i = 0; i < FIFTH_CHAIN.length; i++) {
                const fifthSpan = i - 15; // C is index 15
                let edoStep = (fifthSpan * P5Steps) % EDO;
                if (edoStep < 0) {
                    edoStep += EDO;
                }
                const name = FIFTH_CHAIN[i];
                const absFifthSpan = Math.abs(fifthSpan);

                if (!namedSteps.has(edoStep) || namedSteps.get(edoStep).fifthSpan > absFifthSpan) {
                    // Tie-breaker: keep the name with the smallest absolute fifth span
                    namedSteps.set(edoStep, { name: name, fifthSpan: absFifthSpan });
                }
            }

            // 2. Apply names and handle remaining steps with arrows
            for (let k = 0; k < EDO; k++) {
                if (namedSteps.has(k)) {
                    scale[k].name = namedSteps.get(k).name;
                } else {
                    let nearestStep = -1;
                    let minDiff = Infinity;

                    for (const step of namedSteps.keys()) {
                        let diff = Math.abs(k - step);
                        diff = Math.min(diff, EDO - diff); // Wrap-around difference

                        if (diff < minDiff) {
                            minDiff = diff;
                            nearestStep = step;
                        }
                    }

                    if (nearestStep !== -1) {
                        let diff = k - nearestStep;
                        if (Math.abs(diff) > EDO / 2) {
                            diff = diff > 0 ? diff - EDO : diff + EDO;
                        }

                        const baseName = namedSteps.get(nearestStep).name;
                        const arrow = diff > 0 ? '^' : 'v';
                        const arrows = arrow.repeat(Math.abs(diff));
                        
                        // Arrows applied before the letter name
                        scale[k].name = arrows + baseName;
                    }
                }
            }
            
            return scale;
        }

        // --- UI & EVENT HANDLERS ---

        /** Updates tuning parameters and re-initializes the layout. */
        function updateTuningParameters() {
            const cNoteGridInput = document.getElementById('root-key-input');
            const baseFreqInput = document.getElementById('base-freq-input'); // Read-only for display

            // 1. The target C4 frequency is FIXED as requested
            const c4FixedFreq = C4_FREQ_REF;

            // 2. Update C-Note Grid Index (the grid key that will be C4)
            const newCNoteGridIndex = parseInt(cNoteGridInput.value, 10);
            if (!isNaN(newCNoteGridIndex) && newCNoteGridIndex >= 0) {
                cNoteGridIndex = newCNoteGridIndex;
            } else {
                cNoteGridInput.value = cNoteGridIndex;
            }
            
            // 3. CRUCIAL STEP: Recalculate BaseFreq (Freq of Key 0) 
            // We need BaseFreq * 2^(cNoteGridIndex / EDO) = c4FixedFreq
            // Therefore: BaseFreq = c4FixedFreq * Math.pow(2, -cNoteGridIndex / EDO)
            baseFreq = c4FixedFreq * Math.pow(2, -cNoteGridIndex / EDO);

            // 4. Update Displays
            document.getElementById('base-freq-display').textContent = c4FixedFreq.toFixed(4);
            // Ensure the readonly input field also displays the fixed value
            baseFreqInput.value = c4FixedFreq.toFixed(4); 

            updateKeyLayout(); // This handles updating the layout and clamping index
        }


        /** Initializes the synth by updating EDO and rebuilding the scale names. */
        function initializeSynth() {
            const edoInput = document.getElementById('edo-input');
            const newEDO = parseInt(edoInput.value, 10);
            
            if (isNaN(newEDO) || newEDO <= 0 || newEDO > 2147483647) {
                console.error("Invalid EDO value.");
                edoInput.value = EDO; // Restore last valid EDO
                return;
            }

            EDO = newEDO;
            scaleData = calculateScaleNames(EDO);

            document.getElementById('current-edo').textContent = EDO;

            renderScaleOutput();
            updateTuningParameters(); // This handles recalculating baseFreq and updating the layout
        }

        /** Renders the calculated scale data (names and virtual frequencies) in the output box. */
        function renderScaleOutput() {
            const output = document.getElementById('scale-output');
            const stepSizeCents = CENTS_PER_OCTAVE / EDO;

            let html = `<div>EDO: ${EDO} steps | P5 Steps: ${Math.round(P5_CENTS / stepSizeCents)}</div>`;
            
            scaleData.forEach(s => {
                // Calculate the theoretical C4 frequency for display, based on C4_FREQ_REF
                const freq = C4_FREQ_REF * Math.pow(2, s.step / EDO);
                html += `<div>[${String(s.step).padStart(String(EDO).length, '0')}] ${s.name.padEnd(8, ' ')} ${freq.toFixed(4)} Hz</div>`;
            });
            output.innerHTML = html;
        }

        /** Rerenders the keyboard grid based on current settings. */
        function updateKeyLayout() {
            const rowsInput = document.getElementById('rows-input');
            const colsInput = document.getElementById('cols-input');
            const sizeSlider = document.getElementById('key-size');
            const cNoteGridInput = document.getElementById('root-key-input');
            
            const rows = parseInt(rowsInput.value) || 1;
            const cols = parseInt(colsInput.value) || 1;
            const keySize = parseInt(sizeSlider.value) || 50;

            document.getElementById('key-size-value').textContent = keySize;
            const totalKeys = rows * cols;
            document.getElementById('total-keys').textContent = totalKeys;

            const grid = document.getElementById('keyboard-grid');
            grid.innerHTML = ''; // Clear existing keys
            grid.style.gridTemplateColumns = `repeat(${cols}, ${keySize}px)`;
            grid.style.gridTemplateRows = `repeat(${rows}, ${keySize}px)`;
            grid.classList.add('grid', 'gap-0.5'); // Ensure grid properties are present

            if (scaleData.length === 0) {
                 grid.innerHTML = `<p class="text-gray-500 p-10">Scale not initialized (EDO = ${EDO} not calculated).</p>`;
                 return;
            }
            
            // --- NEW LOGIC FOR CLAMPING C-Note Grid Index ---
            if (cNoteGridIndex >= totalKeys) {
                cNoteGridIndex = Math.max(0, totalKeys - 1); // Clamp to the last key or 0
                cNoteGridInput.value = cNoteGridIndex;
                updateTuningParameters(); // Recalculate baseFreq based on new clamped index
                return; // Redraw happens after successful calculation/initialization
            }
            cNoteGridInput.max = totalKeys - 1; 
            // --------------------------------------------------

            // Stop all currently playing notes before redrawing
            currentNotes.forEach((_, keyIndex) => {
                // We need to look up the frequency from the old key element if it still exists
                const keyElement = document.getElementById(`key-${keyIndex}`);
                if (keyElement) {
                    const freq = parseFloat(keyElement.getAttribute('data-freq'));
                    releaseNote(keyIndex, freq);
                }
            });


            for (let i = 0; i < totalKeys; i++) {
                
                // 1. Calculate the total steps away from the C-Note key (cNoteGridIndex).
                const stepFromCNote = i - cNoteGridIndex;
                
                // 2. Calculate the EDO step index (0 to EDO-1) for naming purposes
                let edoIndex = stepFromCNote % EDO;
                if (edoIndex < 0) {
                    edoIndex += EDO; // Ensure positive EDO index
                }
                
                // 3. Calculate actual frequency: BaseFreq is the frequency of key 0 (i=0).
                // The frequency calculation is relative to the calculated baseFreq (Freq of key 0).
                const totalStepsFromKeyZero = i;
                const actualFreq = baseFreq * Math.pow(2, totalStepsFromKeyZero / EDO);
                
                // 4. Determine the octave number for naming (4 is the C octave at the base freq region)
                // The octave shift is based on the total steps from the C-Note key (cNoteGridIndex).
                const octaveShift = Math.floor(stepFromCNote / EDO);
                const octaveNum = 4 + octaveShift;

                // 5. Get the name from the calculated scale names
                const stepData = scaleData[edoIndex];
                
                // 6. Create the key element
                const key = document.createElement('div');
                key.id = `key-${i}`;
                key.className = 'synth-key rounded-lg shadow-md';
                key.style.width = `${keySize}px`;
                key.style.height = `${keySize}px`;
                key.setAttribute('data-freq', actualFreq);
                key.setAttribute('data-key-index', i);
                
                // Highlight the C-Note key
                if (i === cNoteGridIndex && octaveNum === 4) {
                    key.style.backgroundColor = '#059669'; /* Darker Emerald for C4-note */
                    key.innerHTML = `<span class="key-name text-white font-bold">${stepData.name}${octaveNum} (C4)</span>`;
                    
                    // Sanity check: Log the C4 frequency
                    if (Math.abs(actualFreq - C4_FREQ_REF) > 0.000001) {
                         console.warn(`C4 note frequency mismatch: Expected ${C4_FREQ_REF}, Got ${actualFreq}`);
                    }
                } else {
                    key.innerHTML = `<span class="key-name">${stepData.name}${octaveNum}</span>`;
                }


                // Add event listeners for both mouse and touch
                // MOUSE DOWN: Play or Tap-to-Release
                key.addEventListener('mousedown', (e) => {
                    // Prevent text selection on click/drag, which is fine for desktop UX.
                    e.preventDefault(); 
                    if (Tone.context.state !== 'running') return; 
                    playNote(i, actualFreq);
                });
                // MOUSE UP: Stop only if not sustaining
                key.addEventListener('mouseup', () => {
                    stopNote(i, actualFreq);
                });
                // MOUSE LEAVE: Stop only if not sustaining
                key.addEventListener('mouseleave', () => {
                    stopNote(i, actualFreq);
                });

                // --- MODIFIED TOUCH LISTENERS FOR SCROLLING ---
                // Removed e.preventDefault() from touchstart/touchend to allow vertical page scrolling
                // to start even when the initial touch point is on a key.
                
                // TOUCH START: Play or Tap-to-Release
                key.addEventListener('touchstart', (e) => {
                    // e.preventDefault() REMOVED to allow scrolling
                    if (Tone.context.state !== 'running') return; 
                    playNote(i, actualFreq);
                }, { passive: true });
                
                // TOUCH END: Stop only if not sustaining
                key.addEventListener('touchend', (e) => {
                    // e.preventDefault() REMOVED to allow scrolling
                    stopNote(i, actualFreq);
                }, { passive: true });
                // --- END MODIFIED TOUCH LISTENERS ---

                grid.appendChild(key);
            }
        }

        // --- INITIALIZATION ON LOAD ---
        window.onload = function() {
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded. Cannot start synth.");
                return;
            }
            // Set initial control values
            document.getElementById('rows-input').value = 4;
            document.getElementById('cols-input').value = 8;
            document.getElementById('key-size').value = 50;
            // baseFreq input is now readonly, reflecting C4_FREQ_REF
            document.getElementById('base-freq-input').value = C4_FREQ_REF;
            document.getElementById('root-key-input').value = cNoteGridIndex; 

            // Update range display immediately
            updateVolume();
            document.getElementById('key-size').addEventListener('input', () => {
                document.getElementById('key-size-value').textContent = document.getElementById('key-size').value;
            });
            
            // Set up initial scale and layout
            initializeSynth();
            
            // Allow keyboard input (using bottom rows of keys)
            const keyboardMap = {
                // Lower row (start at key 0)
                'z': 0, 'x': 1, 'c': 2, 'v': 3, 'b': 4, 'n': 5, 'm': 6, ',': 7, 
                // Upper row (start at key 8)
                'a': 8, 's': 9, 'd': 10, 'f': 11, 'g': 12, 'h': 13, 'j': 14, 'k': 15,
                // Top row (start at key 16)
                'q': 16, 'w': 17, 'e': 18, 'r': 19, 't': 20, 'y': 21, 'u': 22, 'i': 23
            };

            const keyStates = new Map(); // Tracks physical key presses 

            document.addEventListener('keydown', (e) => {
                const keyIndex = keyboardMap[e.key.toLowerCase()];
                if (keyIndex !== undefined) {
                    const keyElement = document.getElementById(`key-${keyIndex}`);
                    if (keyElement) {
                        const freq = parseFloat(keyElement.getAttribute('data-freq'));
                        
                        if (!keyStates.has(e.key.toLowerCase())) {
                            keyStates.set(e.key.toLowerCase(), true);
                            playNote(keyIndex, freq); // Calls playNote which handles tap-to-release
                        }
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                const keyIndex = keyboardMap[e.key.toLowerCase()];
                if (keyIndex !== undefined) {
                    keyStates.delete(e.key.toLowerCase());
                    const keyElement = document.getElementById(`key-${keyIndex}`);
                    if (keyElement) {
                        const freq = parseFloat(keyElement.getAttribute('data-freq'));
                        // This uses stopNote, which respects the sustain setting
                        stopNote(keyIndex, freq); 
                    }
                }
            });
        };
    </script>
</body>
</html>

