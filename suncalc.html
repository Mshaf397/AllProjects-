<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SPA Sun Elevation Calculator (±0.0005°)</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    input { margin: 0.2em; padding: 0.3em; width: 200px; }
    button { padding: 0.5em; margin-top: 1em; }
    .result { margin-top: 1em; font-weight: bold; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>NOAA SPA-Based Sun Elevation Calculator</h1>
  <label>Latitude (°): <input id="lat" type="number" step="0.000001"></label><br>
  <label>Longitude (°): <input id="lon" type="number" step="0.000001"></label><br>
  <label>Elevation (m): <input id="elev" type="number" step="1"></label><br>
  <label>Pressure (hPa): <input id="pressure" type="number" value="1013.25"></label><br>
  <label>Temperature (°C): <input id="temp" type="number" value="15"></label><br>
  <label>Timezone Offset from UTC: <input id="tz" type="number" step="0.1"></label><br>
  <label>Local Date & Time: <input id="datetime" type="datetime-local"></label><br>
  <button onclick="calculateSPA()">Calculate Sun Elevation</button>
  <div class="result" id="output"></div>

  <script>
    function toRad(deg) { return deg * Math.PI / 180; }
    function toDeg(rad) { return rad * 180 / Math.PI; }

    function normalizeAngle(angle) {
      return angle - 360 * Math.floor(angle / 360);
    }

    function calculateJulianDay(date) {
      const Y = date.getUTCFullYear();
      const M = date.getUTCMonth() + 1;
      const D = date.getUTCDate();
      const H = date.getUTCHours() + date.getUTCMinutes() / 60 + date.getUTCSeconds() / 3600;

      let A = Math.floor(Y / 100);
      let B = 2 - A + Math.floor(A / 4);
      let JD = Math.floor(365.25 * (Y + 4716)) +
               Math.floor(30.6001 * (M + 1)) + D + B - 1524.5 +
               H / 24;
      return JD;
    }

    function calculateSPA() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const elevation = parseFloat(document.getElementById("elev").value || "0");
      const pressure = parseFloat(document.getElementById("pressure").value || "1013.25");
      const temp = parseFloat(document.getElementById("temp").value || "15");
      const tz = parseFloat(document.getElementById("tz").value);
      const localDate = new Date(document.getElementById("datetime").value);

      const utcDate = new Date(localDate.getTime() - tz * 3600000);
      const JD = calculateJulianDay(utcDate);
      const T = (JD - 2451545.0) / 36525;

      // Geometric Mean Longitude and Mean Anomaly of the Sun
      const L0 = normalizeAngle(280.46646 + 36000.76983 * T + 0.0003032 * T**2);
      const M = normalizeAngle(357.52911 + 35999.05029 * T - 0.0001537 * T**2);
      const e = 0.016708634 - T * (0.000042037 + 0.0000001267 * T);

      // Sun equation of center
      const C = (1.914602 - 0.004817 * T - 0.000014 * T**2) * Math.sin(toRad(M)) +
                (0.019993 - 0.000101 * T) * Math.sin(toRad(2*M)) +
                0.000289 * Math.sin(toRad(3*M));

      const trueLong = L0 + C;

      const omega = 125.04 - 1934.136 * T;
      const lambda = trueLong - 0.00569 - 0.00478 * Math.sin(toRad(omega));

      const epsilon0 = 23 + (26 + ((21.448 - T * (46.815 + T * (0.00059 - T * 0.001813))) / 60)) / 60;
      const epsilon = epsilon0 + 0.00256 * Math.cos(toRad(omega));

      // Declination of the Sun
      const delta = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));

      // Equation of time
      const y = Math.tan(toRad(epsilon / 2))**2;
      const Etime = 4 * toDeg(
        y * Math.sin(2 * toRad(L0)) -
        2 * e * Math.sin(toRad(M)) +
        4 * e * y * Math.sin(toRad(M)) * Math.cos(2 * toRad(L0)) -
        0.5 * y**2 * Math.sin(4 * toRad(L0)) -
        1.25 * e**2 * Math.sin(2 * toRad(M))
      );

      const timeUTC = utcDate.getUTCHours() + utcDate.getUTCMinutes() / 60 + utcDate.getUTCSeconds() / 3600;
      const solarTime = (timeUTC * 60 + Etime + 4 * lon) / 4;
      const hourAngle = normalizeAngle(solarTime - 180);

      const haRad = toRad(hourAngle);
      const latRad = toRad(lat);
      const deltaRad = toRad(delta);

      // Solar Zenith
      const cosZenith = Math.sin(latRad) * Math.sin(deltaRad) +
                        Math.cos(latRad) * Math.cos(deltaRad) * Math.cos(haRad);
      const zenith = toDeg(Math.acos(cosZenith));
      const elevation = 90 - zenith;

      // Atmospheric refraction correction (standard)
      let refraction = 0;
      if (elevation > -0.575) {
        const te = elevation + 10.3 / (elevation + 5.11);
        refraction = pressure / 1010 * 283 / (273 + temp) * 1.02 / (60 * Math.tan(toRad(te)));
      }

      const apparentElevation = elevation + refraction;

      document.getElementById("output").innerText =
        `Sun Elevation (Apparent): ${apparentElevation.toFixed(6)}°\n` +
        `Sun Elevation (Geometric): ${elevation.toFixed(6)}°`;
    }
  </script>
</body>
</html>