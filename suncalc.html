<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Accurate Sun Elevation Calculator</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input { margin: 0.2em; padding: 0.3em; width: 200px; }
    button { padding: 0.5em; margin-top: 1em; }
    .result { margin-top: 1em; font-weight: bold; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Accurate Sun Elevation Calculator (±0.0005°)</h1>
  <label>Latitude (°): <input id="lat" type="number" step="0.000001"></label><br>
  <label>Longitude (°): <input id="lon" type="number" step="0.000001"></label><br>
  <label>Timezone Offset from UTC: <input id="tz" type="number" step="0.1"></label><br>
  <label>Local Date & Time: <input id="datetime" type="datetime-local"></label><br>
  <button onclick="calculateElevation()">Calculate</button>
  <div class="result" id="output"></div>

  <script>
    function toRadians(deg) { return deg * Math.PI / 180; }
    function toDegrees(rad) { return rad * 180 / Math.PI; }

    function calculateElevation() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const tz = parseFloat(document.getElementById("tz").value);
      const localDate = new Date(document.getElementById("datetime").value);

      if (isNaN(lat) || isNaN(lon) || isNaN(tz) || !localDate) {
        document.getElementById("output").innerText = "Please fill all fields correctly.";
        return;
      }

      // Convert to UTC
      const utc = new Date(localDate.getTime() - tz * 3600000);
      const year = utc.getUTCFullYear();
      const month = utc.getUTCMonth() + 1;
      const day = utc.getUTCDate();
      const hour = utc.getUTCHours();
      const minute = utc.getUTCMinutes();
      const second = utc.getUTCSeconds();

      // Julian Day
      const JD = julianDay(year, month, day, hour + minute / 60 + second / 3600);
      const T = (JD - 2451545.0) / 36525;

      // Geometric Mean Longitude of the Sun
      const L0 = (280.46646 + T * (36000.76983 + T * 0.0003032)) % 360;

      // Mean anomaly of the Sun
      const M = 357.52911 + T * (35999.05029 - 0.0001537 * T);

      // Eccentricity of Earth's orbit
      const e = 0.016708634 - T * (0.000042037 + 0.0000001267 * T);

      // Sun equation of center
      const C = (1.914602 - T * (0.004817 + 0.000014 * T)) * Math.sin(toRadians(M)) +
                (0.019993 - 0.000101 * T) * Math.sin(toRadians(2 * M)) +
                0.000289 * Math.sin(toRadians(3 * M));

      // True longitude
      const trueLongitude = L0 + C;

      // Apparent longitude
      const omega = 125.04 - 1934.136 * T;
      const lambda = trueLongitude - 0.00569 - 0.00478 * Math.sin(toRadians(omega));

      // Obliquity of the ecliptic
      const epsilon0 = 23 + (26 + ((21.448 - T * (46.815 + T * (0.00059 - T * 0.001813))) / 60)) / 60;
      const epsilon = epsilon0 + 0.00256 * Math.cos(toRadians(omega));

      // Sun's declination
      const decl = toDegrees(Math.asin(Math.sin(toRadians(epsilon)) * Math.sin(toRadians(lambda))));

      // Equation of time (in minutes)
      const y = Math.tan(toRadians(epsilon / 2)) ** 2;
      const Etime = 4 * toDegrees(
        y * Math.sin(2 * toRadians(L0)) -
        2 * e * Math.sin(toRadians(M)) +
        4 * e * y * Math.sin(toRadians(M)) * Math.cos(2 * toRadians(L0)) -
        0.5 * y ** 2 * Math.sin(4 * toRadians(L0)) -
        1.25 * e ** 2 * Math.sin(2 * toRadians(M))
      );

      // True solar time (in minutes)
      const timeOffset = Etime + 4 * lon - 60 * tz;
      const tst = (hour * 60 + minute + second / 60 + timeOffset) % 1440;

      // Hour angle
      const ha = (tst / 4 < 0 ? tst / 4 + 180 : tst / 4 - 180);

      // Sun elevation
      const solarZenith = toDegrees(Math.acos(
        Math.sin(toRadians(lat)) * Math.sin(toRadians(decl)) +
        Math.cos(toRadians(lat)) * Math.cos(toRadians(decl)) * Math.cos(toRadians(ha))
      ));
      const solarElevation = 90 - solarZenith;

      document.getElementById("output").innerText = `Sun Elevation: ${solarElevation.toFixed(6)}°`;
    }

    function julianDay(year, month, day, hourDecimal) {
      if (month <= 2) {
        year -= 1;
        month += 12;
      }
      const A = Math.floor(year / 100);
      const B = 2 - A + Math.floor(A / 4);
      const JD = Math.floor(365.25 * (year + 4716)) +
                 Math.floor(30.6001 * (month + 1)) +
                 day + B - 1524.5 + hourDecimal / 24;
      return JD;
    }
  </script>
</body>
</html>