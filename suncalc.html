<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SPA Sun Elevation Calculator</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    input { margin: 0.2em; padding: 0.3em; width: 200px; }
    button { padding: 0.5em; margin-top: 1em; }
    .result { margin-top: 1em; font-weight: bold; font-size: 1.2em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>SPA-Based Sun Elevation Calculator (±0.0005°)</h1>
  <label>Latitude (°): <input id="lat" type="number" step="0.000001" value="41.0"></label><br>
  <label>Longitude (°): <input id="lon" type="number" step="0.000001" value="-74.0"></label><br>
  <label>Elevation (m): <input id="elev" type="number" value="0"></label><br>
  <label>Pressure (hPa): <input id="pressure" type="number" value="1013.25"></label><br>
  <label>Temperature (°C): <input id="temp" type="number" value="15"></label><br>
  <label>Timezone Offset (e.g. -4 for EDT): <input id="tz" type="number" value="-4"></label><br>
  <label>Local Date/Time: <input id="datetime" type="datetime-local" value="2025-08-04T09:55"></label><br>
  <button onclick="calculateSPA()">Calculate Sun Elevation</button>

  <div class="result" id="output"></div>

  <script>
    function toRad(deg) { return deg * Math.PI / 180; }
    function toDeg(rad) { return rad * 180 / Math.PI; }
    function normalize(deg) { return (deg % 360 + 360) % 360; }

    function julianDay(year, month, day, hourDecimal) {
      if (month <= 2) { year -= 1; month += 12; }
      const A = Math.floor(year / 100);
      const B = 2 - A + Math.floor(A / 4);
      return Math.floor(365.25 * (year + 4716))
           + Math.floor(30.6001 * (month + 1))
           + day + B - 1524.5 + hourDecimal / 24;
    }

    function calculateSPA() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const elev = parseFloat(document.getElementById("elev").value);
      const pressure = parseFloat(document.getElementById("pressure").value);
      const temp = parseFloat(document.getElementById("temp").value);
      const tz = parseFloat(document.getElementById("tz").value);
      const local = new Date(document.getElementById("datetime").value);

      if (isNaN(lat) || isNaN(lon) || isNaN(tz) || !local) {
        document.getElementById("output").innerText = "Please fill all fields correctly.";
        return;
      }

      const utc = new Date(local.getTime() - tz * 3600 * 1000);
      const year = utc.getUTCFullYear();
      const month = utc.getUTCMonth() + 1;
      const day = utc.getUTCDate();
      const hour = utc.getUTCHours();
      const minute = utc.getUTCMinutes();
      const second = utc.getUTCSeconds();
      const decimalHours = hour + minute / 60 + second / 3600;

      const JD = julianDay(year, month, day, decimalHours);
      const T = (JD - 2451545.0) / 36525;

      const L0 = normalize(280.46646 + 36000.76983 * T + 0.0003032 * T**2);
      const M = normalize(357.52911 + 35999.05029 * T - 0.0001537 * T**2);
      const e = 0.016708634 - T * (0.000042037 + 0.0000001267 * T);

      const C = (1.914602 - 0.004817 * T - 0.000014 * T**2) * Math.sin(toRad(M)) +
                (0.019993 - 0.000101 * T) * Math.sin(toRad(2 * M)) +
                0.000289 * Math.sin(toRad(3 * M));

      const trueLong = L0 + C;
      const omega = 125.04 - 1934.136 * T;
      const lambda = trueLong - 0.00569 - 0.00478 * Math.sin(toRad(omega));

      const epsilon0 = 23 + (26 + ((21.448 - T * (46.815 + T * (0.00059 - T * 0.001813))) / 60)) / 60;
      const epsilon = epsilon0 + 0.00256 * Math.cos(toRad(omega));

      const delta = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));

      const y = Math.tan(toRad(epsilon / 2)) ** 2;
      const eqTime = 4 * toDeg(
        y * Math.sin(2 * toRad(L0)) -
        2 * e * Math.sin(toRad(M)) +
        4 * e * y * Math.sin(toRad(M)) * Math.cos(2 * toRad(L0)) -
        0.5 * y ** 2 * Math.sin(4 * toRad(L0)) -
        1.25 * e ** 2 * Math.sin(2 * toRad(M))
      );

      const timeOffset = eqTime + 4 * lon - 60 * tz;
      const tst = (decimalHours * 60 + timeOffset) % 1440;
      const ha = (tst / 4 < 0) ? (tst / 4 + 180) : (tst / 4 - 180);

      const haRad = toRad(ha);
      const latRad = toRad(lat);
      const deltaRad = toRad(delta);

      const cosZenith = Math.sin(latRad) * Math.sin(deltaRad) +
                        Math.cos(latRad) * Math.cos(deltaRad) * Math.cos(haRad);
      const zenith = toDeg(Math.acos(cosZenith));
      const elevation = 90 - zenith;

      // Atmospheric refraction (approximate)
      let refraction = 0;
      if (elevation > -0.575) {
        const te = elevation + 10.3 / (elevation + 5.11);
        refraction = pressure / 1010 * 283 / (273 + temp) * 1.02 / (60 * Math.tan(toRad(te)));
      }

      const appElevation = elevation + refraction;

      document.getElementById("output").innerText =
        `UTC: ${utc.toISOString().slice(0, 19).replace('T', ' ')}\n` +
        `Sun Elevation (Geometric): ${elevation.toFixed(6)}°\n` +
        `Sun Elevation (Apparent): ${appElevation.toFixed(6)}°`;
    }
  </script>
</body>
</html>