<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Kindle Map Explorer</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    table { margin: auto; border-spacing: 0; }
    td { padding: 0; }
    img { width: 256px; height: 256px; display: block; }
    .nav a {
      margin: 6px;
      text-decoration: none;
      font-size: 20px;
      display: inline-block;
    }
  </style>
</head>
<body>

<h2>Kindle Map Explorer</h2>

<div id="coords" style="margin-bottom:10px; font-size:14px; color:gray;"></div>

<script>
  const query = new URLSearchParams(window.location.search);
  let z = parseInt(query.get("z")) || 4;
  let cx = parseInt(query.get("x")) || 8;
  let cy = parseInt(query.get("y")) || 5;

  const max = Math.pow(2, z);

  // Wrap X (longitude), clamp Y (latitude)
  const wrapX = x => (x + max) % max;
  const clampY = y => Math.max(0, Math.min(max - 1, y));

  const tileURL = (z, x, y) =>
    `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;

  // Convert tile x,y,z to lat/lon
  function tileToLatLon(x, y, z) {
    const n = Math.pow(2, z);
    const lon = x / n * 360 - 180;
    const latRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
    const lat = latRad * 180 / Math.PI;
    return { lat: lat.toFixed(5), lon: lon.toFixed(5) };
  }

  function showCoords(x, y, z) {
    const { lat, lon } = tileToLatLon(x, y, z);
    const el = document.getElementById("coords");
    el.innerText = `Tile ${z}/${x}/${y} → Lat: ${lat}, Lon: ${lon}`;
  }

  // Render 5x5 grid centered at cx, cy
  const radius = 2;
  document.write('<table>');
  for (let dy = -radius; dy <= radius; dy++) {
    document.write('<tr>');
    for (let dx = -radius; dx <= radius; dx++) {
      const tx = wrapX(cx + dx);
      const ty = clampY(cy + dy);
      const url = tileURL(z, tx, ty);
      document.write(`<td><a href="javascript:showCoords(${tx},${ty},${z})"><img src="${url}" alt="${z}/${tx}/${ty}"></a></td>`);
    }
    document.write('</tr>');
  }
  document.write('</table>');

  // Navigation
  const north = clampY(cy - 1);
  const south = clampY(cy + 1);
  const west = wrapX(cx - 1);
  const east = wrapX(cx + 1);

  document.write(`
    <div class="nav">
      <p>
        <a href="?z=${z}&x=${cx}&y=${north}">↑ North</a><br>
        <a href="?z=${z}&x=${west}&y=${cy}">← West</a>
        <a href="?z=${z}&x=${east}&y=${cy}">→ East</a><br>
        <a href="?z=${z}&x=${cx}&y=${south}">↓ South</a>
      </p>
      <p>
        <a href="?z=${z + 1}&x=${cx * 2}&y=${cy * 2}">Zoom In</a> |
        <a href="?z=${z - 1}&x=${Math.floor(cx / 2)}&y=${Math.floor(cy / 2)}">Zoom Out</a>
      </p>
    </div>
  `);
</script>

<p style="font-size:12px;">
  Tiles © <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors
</p>

</body>
</html>